# Authorization against keycloak

## Default configuration
### User:
Credentials: `admin/admin`
IP address: `localhost:2137`

### Clients:
#### Competition:
- Client ID: `competition-manager-web`
- Client Secret: `<not-applicable>`
- Client Protocol: `openid-connect`
- Access Type: `public`
- Standard Flow Enabled: `ON`
- Password Flow Enabled: `OFF`
- Valid Redirect URIs: `http://localhost:80/*`

## Challenge Pair generator:
For safety reasons `pkce` grant should be used instead of regular `authorization_code` grant.
To generate `code_verifier` and `code_challenge` use [`generate_challenge_pair.py`](./challenge_pair_generator.py) script.
```py
import secrets
import hashlib
import base64

code_verifier = tmp if not (tmp := input("Enter code verifier (leave empty for autogenerated): ")) == "" else secrets.token_urlsafe(64)

code_challenge = base64.urlsafe_b64encode(hashlib.sha256(code_verifier.encode()).digest()).decode().replace("=", "")

print(f"Code verifier: {code_verifier}")
print(f"Code challenge: {code_challenge}")
```

## Available endpoints:
### Authorization:
Redirect user to:
```http request
GET /realms/CompetitionManager/protocol/openid-connect/auth HTTP/1.1
Host: localhost:2137

client_id=competition-manager-web
&redirect_uri=http://localhost:80/
state=<generated-state>
&response_type=code
&scope=email profile openid
&code_challenge=<generated-code-challenge>
&code_challenge_method=S256
&grant_type=pkce
```

Remember always to check if `state` on the response is the same as the one you sent.  
After user logs in browser will redirect you to:

```http request
GET /?state=<generated-state>&session_state=<generated-session-state>&code=<received-code> HTTP/1.1
Host: <redirect-uri>
```

### Token:
```http request
POST /realms/CompetitionManager/protocol/openid-connect/token HTTP/1.1
Host: localhost:2137

code=<received-code>
&grant_type=authorization_code
&client_id=competition-manager-web
&redirect_uri=http://localhost:80/
&code_verifier=<generated-code-verifier>
```

Both `code` and `code_verifier` should be the ones you received/generated in previous step.  
In response you will receive following json:
```json
{
    "access_token": <access-token>,
    "expires_in": 300,
    "refresh_expires_in": 1786,
    "refresh_token": <refresh-token>,
    "token_type": "Bearer", 
    "not-before-policy": 0,
    "session_state": <your-session-state>,
    "scope": "openid email profile"
}
```

### Refresh token:
```http request
POST /realms/CompetitionManager/protocol/openid-connect/token HTTP/1.1
Host: localhost:2137

grant_type=refresh_token
&client_id=competition-manager-web
&refresh_token=<refresh-token>
```

In response you will receive same json as in [Token](#token):
```json
{
    "access_token": <access-token>,
    "expires_in": 300,
    "refresh_expires_in": 1786,
    "refresh_token": <refresh-token>,
    "token_type": "Bearer", 
    "not-before-policy": 0,
    "session_state": <your-session-state>,
    "scope": "openid email profile"
}
```


### User info:
```http request
GET /realms/CompetitionManager/protocol/openid-connect/userinfo HTTP/1.1
HOST: localhost:2137

Content-Type: application/x-www-form-urlencoded
Authorization: Bearer <access-token>
```

In response **if user exists** you will be served following json:
```json
{
    "sub": "4ba86962-8c1b-475c-a511-c775d389b348",
    "email_verified": false,
    "name": "User One",
    "preferred_username": "user1",
    "given_name": "User",
    "family_name": "One",
    "email": "example@example.org"
}
```